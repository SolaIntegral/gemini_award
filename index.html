<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Certificate (model-viewer)</title>
    
    <!-- model-viewerã®èª­ã¿è¾¼ã¿ -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #1a202c;
            font-family: 'Noto Sans JP', sans-serif;
            height: 100vh;
            width: 100vw;
        }

        /* model-vieweræœ¬ä½“ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        model-viewer {
            width: 100%;
            height: 100%;
            background-color: #1a202c;
            --poster-color: transparent;
        }
        
        /* model-viewerã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’éè¡¨ç¤º */
        model-viewer::part(default-ar-button) {
            display: none;
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ã®éè¡¨ç¤º */
        model-viewer::part(default-progress-bar) {
            display: none;
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ARãƒœã‚¿ãƒ³ */
        .ar-button {
            background-color: white;
            border-radius: 4px;
            border: none;
            position: absolute;
            bottom: 16px;
            right: 16px;
            padding: 12px 24px;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.25);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* ã‚¿ã‚¤ãƒˆãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .title-overlay {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            pointer-events: none; /* 3Dæ“ä½œã®é‚ªé­”ã«ãªã‚‰ãªã„ã‚ˆã†ã« */
            z-index: 10;
        }

        .title-box {
            background: rgba(255, 215, 0, 0.9); /* ã‚´ãƒ¼ãƒ«ãƒ‰èƒŒæ™¯ */
            color: #000;
            padding: 10px 30px;
            border-radius: 50px;
            display: inline-block;
            font-weight: bold;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .subtitle {
            margin-top: 10px;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            font-size: 16px;
        }

        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* ARèµ·å‹•ä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
        :not(:defined) > * {
            display: none;
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã®åˆ¶å¾¡ */
        model-viewer.loading::before {
            content: 'Loading AR Award...';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            z-index: 100;
        }
        
        model-viewer:not(.loading)::before {
            display: none;
        }
        
        /* ARã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        model-viewer[ar-status="session-started"] {
            background-color: transparent;
        }
    </style>
</head>
<body>

    <!-- ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤ºï¼ˆç”»é¢æ‰‹å‰ã«å›ºå®šï¼‰ -->
    <div class="title-overlay">
        <div class="title-box">WINNER!</div>
        <div class="subtitle">Gemini Hackathon 2025</div>
    </div>

    <!-- 
        model-viewerã®è¨­å®š
        src: 3Dãƒ¢ãƒ‡ãƒ«(.glb)ã®URLã€‚ç¾åœ¨ã¯ã‚µãƒ³ãƒ—ãƒ«ã®å®‡å®™é£›è¡Œå£«ã§ã™ã€‚
             ã“ã“ã‚’ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ã®.glbãƒ•ã‚¡ã‚¤ãƒ«ã®URLã«æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚
        ar: ARæ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
        ar-modes: "webxr scene-viewer quick-look" 
                  -> Android(WebXR/SceneViewer)ã¨iOS(Quick Look)ã®ä¸¡å¯¾å¿œè¨­å®š
        camera-controls: æŒ‡ã§å›è»¢ãƒ»æ‹¡å¤§ç¸®å°å¯èƒ½ã«
        auto-rotate: è‡ªå‹•å›è»¢
        shadow-intensity: å½±ã®æ¿ƒã•
    -->
    <model-viewer 
        id="award-viewer"
        src="https://modelviewer.dev/shared-assets/models/Astronaut.glb"
        ar 
        ar-modes="scene-viewer webxr quick-look" 
        camera-controls 
        auto-rotate
        shadow-intensity="1"
        camera-orbit="0deg 90deg 2.5m"
        alt="A 3D model of an award"
        loading="auto"
        reveal="auto">
        
        <!-- ARèµ·å‹•ãƒœã‚¿ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ -->
        <button slot="ar-button" class="ar-button">
            ğŸ‘‹ ARã§å®Ÿå¯¸å¤§è¡¨ç¤º
        </button>

    </model-viewer>

    <script>
        // model-viewerè¦ç´ ã‚’å–å¾—
        const modelViewer = document.querySelector('model-viewer');
        
        // åˆæœŸçŠ¶æ…‹ã§ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
        if (modelViewer) {
            modelViewer.classList.add('loading');
        }
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’ç®¡ç†
        let isLoading = true;
        let arSessionActive = false;
        
        // model-viewerãŒå®šç¾©ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
        customElements.whenDefined('model-viewer').then(() => {
            console.log('model-viewerãŒå®šç¾©ã•ã‚Œã¾ã—ãŸ');
        });
        
        // ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿å®Œäº†æ™‚
        modelViewer.addEventListener('load', () => {
            console.log('ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸ');
            isLoading = false;
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’éè¡¨ç¤ºã«ã™ã‚‹
            modelViewer.classList.remove('loading');
        });
        
        // ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿é–‹å§‹æ™‚
        modelViewer.addEventListener('progress', (event) => {
            const progress = event.detail.totalProgress;
            console.log('èª­ã¿è¾¼ã¿é€²æ—:', Math.round(progress * 100) + '%');
            if (progress >= 1.0) {
                isLoading = false;
                modelViewer.classList.remove('loading');
            }
        });
        
        // ARçŠ¶æ…‹ã®ç›£è¦–
        modelViewer.addEventListener('ar-status', (event) => {
            const status = event.detail.status;
            console.log('AR Status:', status, event.detail);
            
            switch(status) {
                case 'not-presenting':
                    // ARã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚Œã¦ã„ãªã„ã€ã¾ãŸã¯çµ‚äº†ã—ãŸ
                    arSessionActive = false;
                    isLoading = false;
                    modelViewer.classList.remove('loading');
                    console.log('ARã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã™');
                    break;
                    
                case 'session-started':
                    // ARã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚ŒãŸ
                    arSessionActive = true;
                    isLoading = false;
                    modelViewer.classList.remove('loading');
                    console.log('ARã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ');
                    break;
                    
                case 'failed':
                    // ARã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹ã«å¤±æ•—
                    console.error('ARã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ', event.detail);
                    isLoading = false;
                    modelViewer.classList.remove('loading');
                    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆãŸã ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¢ã«ã‚«ãƒ¡ãƒ©è¨±å¯ã‚’ã—ãŸå ´åˆã¯è¡¨ç¤ºã—ãªã„ï¼‰
                    if (event.detail.message && !event.detail.message.includes('permission')) {
                        alert('ARæ©Ÿèƒ½ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + event.detail.message);
                    }
                    break;
                    
                case 'not-supported':
                    console.warn('ARæ©Ÿèƒ½ã¯ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    isLoading = false;
                    modelViewer.classList.remove('loading');
                    break;
                    
                default:
                    console.log('æœªçŸ¥ã®ARã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', status);
                    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è§£é™¤ï¼ˆå®‰å…¨ã®ãŸã‚ï¼‰
                    if (status !== 'presenting') {
                        isLoading = false;
                        modelViewer.classList.remove('loading');
                    }
            }
        });
        
        // ARãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°çŠ¶æ…‹ã®ç›£è¦–
        modelViewer.addEventListener('ar-tracking', (event) => {
            console.log('AR Tracking:', event.detail.status);
            if (event.detail.status === 'tracking') {
                isLoading = false;
            }
        });
        
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        modelViewer.addEventListener('error', (event) => {
            console.error('Model viewer error:', event.detail);
            isLoading = false;
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¨ãƒ©ãƒ¼ã‚’é€šçŸ¥
            if (event.detail.type === 'load') {
                alert('3Dãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        });
        
        // WebXR APIã®ã‚µãƒãƒ¼ãƒˆç¢ºèªã¨åˆæœŸåŒ–
        if ('xr' in navigator) {
            navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
                console.log('WebXR AR supported:', supported);
                if (!supported) {
                    console.warn('WebXR ARã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Scene Viewerã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¾ã™ã€‚');
                }
            }).catch((error) => {
                console.error('WebXR check error:', error);
            });
        }
        
        // ã‚«ãƒ¡ãƒ©è¨±å¯ã®ç¢ºèªï¼ˆAndroidç”¨ï¼‰
        async function checkCameraPermission() {
            try {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    // ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚ŒãŸã‚‰ã€ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
                    stream.getTracks().forEach(track => track.stop());
                    console.log('ã‚«ãƒ¡ãƒ©ã®è¨±å¯ãŒç¢ºèªã•ã‚Œã¾ã—ãŸ');
                    return true;
                }
            } catch (error) {
                console.error('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã®ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚«ãƒ¡ãƒ©ã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚è¨­å®šã‹ã‚‰ã‚«ãƒ¡ãƒ©ã®è¨±å¯ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚');
                return false;
            }
        }
        
        // ARãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
        const arButton = document.querySelector('.ar-button');
        if (arButton) {
            arButton.addEventListener('click', async () => {
                console.log('ARãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                
                // WebXRã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã®ã¿ã‚«ãƒ¡ãƒ©è¨±å¯ã‚’ç¢ºèª
                // Scene Viewerã®å ´åˆã¯ä¸è¦ï¼ˆãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã¨ã—ã¦å‹•ä½œï¼‰
                if (navigator.xr) {
                    try {
                        const isWebXRSupported = await navigator.xr.isSessionSupported('immersive-ar');
                        if (isWebXRSupported) {
                            // WebXRã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€ã‚«ãƒ¡ãƒ©è¨±å¯ã‚’ç¢ºèª
                            const hasPermission = await checkCameraPermission();
                            if (!hasPermission) {
                                return; // è¨±å¯ãŒãªã‘ã‚Œã°å‡¦ç†ã‚’ä¸­æ–­
                            }
                        }
                    } catch (error) {
                        console.log('WebXR check failed, using Scene Viewer:', error);
                    }
                }
                
                // ARã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ï¼ˆScene Viewerã¾ãŸã¯WebXRï¼‰
                try {
                    // model-viewerãŒè‡ªå‹•çš„ã«é©åˆ‡ãªARãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¾ã™
                    // æ‰‹å‹•ã§activateAR()ã‚’å‘¼ã¶å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“
                    console.log('ARã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹ã‚’è©¦ã¿ã¾ã™...');
                } catch (error) {
                    console.error('AR activation error:', error);
                    alert('ARæ©Ÿèƒ½ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            });
        }
        
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼ˆ5ç§’å¾Œã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è§£é™¤ï¼‰
        setTimeout(() => {
            if (isLoading && !arSessionActive) {
                console.warn('ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å¼·åˆ¶çš„ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è§£é™¤ã—ã¾ã™ã€‚');
                isLoading = false;
                modelViewer.classList.remove('loading');
            }
        }, 5000);
        
        // ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸæ™‚ç‚¹ã§ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è§£é™¤ï¼ˆãƒ¢ãƒ‡ãƒ«ãŒæ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (modelViewer.loaded) {
                    console.log('ãƒ¢ãƒ‡ãƒ«ã¯æ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã™');
                    isLoading = false;
                    modelViewer.classList.remove('loading');
                }
            }, 1000);
        });
    </script>
</body>
</html>
